RewriteEngine On
RewriteBase /

# Allow direct access to assets (CSS, JS, images) and .well-known
RewriteCond %{REQUEST_URI} ^/assets/ [OR]
RewriteCond %{REQUEST_URI} ^/uploads/ [OR]
RewriteCond %{REQUEST_URI} ^/\.well-known/
RewriteRule ^ - [L]

# Redirect to index.php if file doesn't exist
# Don't check for files/directories - always route to index.php for non-asset paths
RewriteCond %{REQUEST_URI} !^/assets/
RewriteCond %{REQUEST_URI} !^/uploads/
RewriteCond %{REQUEST_URI} !^/\.well-known/
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)$ index.php [QSA,L]

# Prevent directory listing
Options -Indexes

# Set UTF-8 encoding
AddDefaultCharset UTF-8

# Security headers
<IfModule mod_headers.c>
    Header set X-Content-Type-Options "nosniff"
    Header set X-Frame-Options "SAMEORIGIN"
    Header set X-XSS-Protection "1; mode=block"
    
    # Ensure CSS files are served with correct MIME type
    <FilesMatch "\.(css)$">
        Header set Content-Type "text/css; charset=UTF-8"
    </FilesMatch>
    
    # Cache control for CSS and JS (with version query string, cache is handled by browser)
    <FilesMatch "\.(css|js)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
    </FilesMatch>
    
    # API endpoints - no cache to ensure fresh data
    <FilesMatch "index\.php">
        Header set Cache-Control "no-cache, no-store, must-revalidate"
        Header set Pragma "no-cache"
        Header set Expires "0"
    </FilesMatch>
    
    # Connection keep-alive for better performance
    Header set Connection "keep-alive"
</IfModule>

# Ensure CSS files are served with correct MIME type
<IfModule mod_mime.c>
    AddType text/css .css
    AddCharset UTF-8 .css
</IfModule>

# PHP Upload Settings (override php.ini if allowed by server)
# Note: This only works if PHP is running as Apache module or with PHP-FPM
# If this doesn't work, you need to modify php.ini directly
# Set to 6M for buffer (app limit is 5MB)
<IfModule mod_php7.c>
    php_value upload_max_filesize 6M
    php_value post_max_size 6M
    php_value max_execution_time 300
    php_value max_input_time 300
</IfModule>
<IfModule mod_php8.c>
    php_value upload_max_filesize 6M
    php_value post_max_size 6M
    php_value max_execution_time 300
    php_value max_input_time 300
</IfModule>

